<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live ICD-10 Search (API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
        <div class="p-6 md:p-8">
            <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">ICD-10 Explorer</h1>
            <p class="text-gray-500 mb-6 text-center">Real-time search powered by the NIH Clinical Tables API.</p>

            <div class="relative mb-6">
                <input type="text" id="searchInput"
                    placeholder="Search by description or code (e.g. 'Diabetes' or 'I10')"
                    class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" />
                <div id="loadingSpinner" class="hidden absolute right-4 top-3.5">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></div>
                </div>
            </div>

            <div id="resultsContainer" class="max-h-96 overflow-y-auto pr-2">
                <div class="bg-gray-50 text-gray-400 text-sm p-4 rounded-xl text-center">
                    Type at least 3 characters to search...
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const resultsContainer = document.getElementById('resultsContainer');
            const loader = document.getElementById('loadingSpinner');

            let debounceTimer;
            let abortController; // To cancel previous requests
            const cache = new Map(); // Simple in-memory cache

            const fetchICD10 = async (term) => {
                // 1. Check Cache first
                if (cache.has(term)) {
                    renderResults(cache.get(term));
                    return;
                }

                // 2. Cancel any pending request
                if (abortController) abortController.abort();
                abortController = new AbortController();

                loader.classList.remove('hidden');

                try {
                    const url = `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(term)}&maxList=20`;
                    const response = await fetch(url, { signal: abortController.signal });
                    const data = await response.json();

                    const results = (data[3] || []).map(item => ({ code: item[0], description: item[1] }));

                    // 3. Store in cache
                    cache.set(term, results);
                    renderResults(results);
                } catch (error) {
                    if (error.name === 'AbortError') return; // Expected when typing fast
                    console.error('API Error:', error);
                    resultsContainer.innerHTML = `<div class="p-4 text-red-500 text-center">Error fetching results.</div>`;
                } finally {
                    if (!abortController.signal.aborted) loader.classList.add('hidden');
                }
            };

            const renderResults = (results) => {
                resultsContainer.innerHTML = '';
                if (results.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-4 text-gray-400 text-center">No codes found.</div>`;
                    return;
                }

                // 4. Use DocumentFragment for performance
                const fragment = document.createDocumentFragment();

                results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-xl shadow-sm mb-2 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all cursor-pointer group';
                    div.innerHTML = `
                <div class="flex justify-between items-start">
                    <span class="font-bold text-blue-600 text-lg">${item.code}</span>
                    <span class="text-xs text-gray-400 opacity-0 group-hover:opacity-100">Click to Copy</span>
                </div>
                <div class="text-gray-700 text-sm mt-1">${item.description}</div>
            `;
                    div.onclick = () => {
                        navigator.clipboard.writeText(item.code);
                        // Non-blocking notification is better than alert()
                        console.log(`Copied ${item.code}`);
                    };
                    fragment.appendChild(div);
                });

                resultsContainer.appendChild(fragment);
            };

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearTimeout(debounceTimer);

                if (query.length < 3) {
                    resultsContainer.innerHTML = `<div class="p-4 text-gray-400 text-center">Type at least 3 characters...</div>`;
                    return;
                }

                debounceTimer = setTimeout(() => fetchICD10(query), 250); // Slightly faster debounce
            });
        });
    </script>
</body>

</html>